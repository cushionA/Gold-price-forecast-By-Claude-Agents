{
  "feature": "options_market",
  "attempt": 3,
  "phase": "phase2_submodel_retry",
  "created_at": "2026-02-22",
  "agent_sequence": ["evaluator", "architect", "builder_data", "datachecker", "builder_model"],

  "objective": "Improve options_market submodel from attempt 2 (Gate 3 PASS via MAE only) to simultaneously improve DA and/or Sharpe. Attempt 2 had strong MAE (-0.156, 15.6x) but still negative DA delta (-0.24%) and Sharpe delta (-0.141). This is an automation pipeline test (automation_test=true, max_attempt=5).",

  "background": {
    "attempt_1_result": "Gate 3 FAIL. 3 output columns (regime_prob + tail_risk_z + skew_momentum_z). DA degraded in ALL 5 folds. Gate 2 PASS (MI +17.12%). Problem: too many noisy columns.",
    "attempt_2_result": "Gate 3 PASS via MAE (-0.1562, 15.6x threshold, 4/5 folds). Reduced to 1 column (options_risk_regime_prob only). DA improved 3/5 folds vs 0/5 in attempt 1. Gate 2 FAIL marginally: MI 4.96% (threshold 5%), stability 0.1555 (threshold 0.15). Feature rank: #2 (7.55% importance).",
    "remaining_weaknesses": {
      "DA_delta": -0.0024,
      "Sharpe_delta": -0.1413,
      "MI_increase": 0.0496,
      "stability": 0.1555,
      "gate2_passed": false
    }
  },

  "previous_feedback": {
    "attempt_2_gate3": "PASS via MAE only. DA and Sharpe still need improvement.",
    "anti_patterns": [
      "DO NOT use 3+ output columns without strong evidence each column contributes unique MI",
      "DO NOT use HMM without smoothing if stability > 0.15",
      "DO NOT add noise features (tail_risk_z, skew_momentum_z had low MI: 0.002, 0.017)"
    ]
  },

  "design_approach": {
    "primary_direction": "Improve Gate 2 compliance and DA/Sharpe by modifying the HMM output or adding a complementary signal",
    "options": [
      {
        "name": "Smoothed regime prob + options volume trend",
        "description": "Apply EMA smoothing to regime_prob (reduce stability from 0.1555 to <0.15). Add a 2nd output: options volume trend z-score (normalized put volume change). VIF check needed.",
        "rationale": "Smoothing addresses stability. Volume trend captures positioning changes that may correlate with short-term gold direction."
      },
      {
        "name": "3-state HMM",
        "description": "Expand from 2-state to 3-state HMM (low/medium/high risk) to increase MI above 5% threshold.",
        "rationale": "More states should capture more variance in options behavior, increasing MI above 5%."
      },
      {
        "name": "Different input features for HMM",
        "description": "Replace or augment current HMM inputs with put/call ratio changes and SKEW index changes.",
        "rationale": "Better inputs to HMM may produce more discriminative regime output."
      }
    ],
    "architect_decides": "Choose best approach or combine, ensuring output has max 2 columns with VIF < 10"
  },

  "output_spec": {
    "file": "data/processed/options_market/data.csv",
    "format": "CSV with date index",
    "columns": "1-2 features maximum",
    "date_range": "Matching target.csv",
    "nan_handling": "NaN for warmup period. No forward-fill."
  },

  "constraints": [
    "Maximum 2 output features (VIF must be < 10)",
    "No hardcoded API keys",
    "kernel-metadata.json must include dataset_sources: ['bigbigzabuton/gold-prediction-submodels']",
    "FRED API key via Kaggle Secrets (UserSecretsClient)",
    "automation_test mode: evaluator will continue even if Gate 3 PASS (forced by retry_ctx)"
  ],

  "success_criteria": {
    "gate1": "No overfitting, no all-NaN or constant columns",
    "gate2": "MI increase > 5% AND stability < 0.15 (both must pass)",
    "gate3": "Any one of: DA delta > +0.5%, Sharpe delta > +0.05, MAE delta < -0.01%. Priority: positive DA delta or Sharpe delta.",
    "stretch_goal": "Pass Gate 2 while maintaining or improving Gate 3 MAE improvement"
  },

  "kaggle_config": {
    "kernel_id": "bigbigzabuton/gold-options-market-3",
    "notebook_path": "notebooks/options_market_3/",
    "dataset_sources": ["bigbigzabuton/gold-prediction-submodels"]
  },

  "automation_test_ctx": {
    "automation_test": true,
    "max_attempt": 5,
    "note": "Pipeline will automatically continue to attempts 4 and 5 regardless of evaluator decision. This tests the automation pipeline end-to-end."
  }
}
