{
  "task_type": "meta_model",
  "feature": "meta_model",
  "attempt": 2,
  "phase": "phase3_meta_model",
  "source": "evaluator",
  "objective": "Build a regression meta-model integrating stationary base features + submodel outputs (excluding CNY and price-level features) to predict next-day gold return (%). Must simultaneously achieve DA > 56%, HC-DA > 60%, MAE < 0.75%, Sharpe > 0.8.",

  "requirements": "Meta-model must use ONLY stationary/bounded features. All raw price-level base features (gld_open/high/low/close, silver_close, copper_close, sp500_close, volumes) and CNY features must be excluded. Use standard reg:squarederror loss (no custom directional penalty). Apply aggressive regularization to prevent overfitting (target: train-test DA gap < 10pp). Fix data pipeline to retain ~2000+ training samples. Align Sharpe formula to CLAUDE.md specification (cost on position changes only, not daily).",

  "inputs": {
    "base_features": "data/processed/base_features.csv",
    "submodel_outputs": [
      "data/submodel_outputs/vix.csv",
      "data/submodel_outputs/technical.csv",
      "data/submodel_outputs/cross_asset.csv",
      "data/submodel_outputs/yield_curve.csv",
      "data/submodel_outputs/etf_flow.csv",
      "data/submodel_outputs/inflation_expectation.csv"
    ],
    "submodel_columns": {
      "vix": ["vix_regime_probability", "vix_mean_reversion_z", "vix_persistence"],
      "technical": ["tech_trend_regime_prob", "tech_mean_reversion_z", "tech_volatility_regime"],
      "cross_asset": ["xasset_regime_prob", "xasset_recession_signal", "xasset_divergence"],
      "yield_curve": ["yc_spread_velocity_z", "yc_curvature_z"],
      "etf_flow": ["etf_regime_prob", "etf_capital_intensity", "etf_pv_divergence"],
      "inflation_expectation": ["ie_regime_prob", "ie_anchoring_z", "ie_gold_sensitivity_z"]
    },
    "excluded_submodels": ["real_rate", "dxy", "cny_demand"],
    "excluded_columns": ["yc_regime_prob"],
    "target": "data/processed/target.csv"
  },

  "research_questions": [
    "Q1: Given the Attempt 1 failure with 94.3% train DA / 46.9% val DA, what specific regularization settings for XGBoost achieve train-test DA gap < 10pp on financial return prediction with ~1700 training samples and 24 features?",
    "Q2: With standard reg:squarederror loss, how should the Optuna objective be structured to simultaneously optimize DA and Sharpe? Should DA be measured directly in the objective, or does it emerge naturally from accurate return predictions?",
    "Q3: Which base features are stationary and should be retained? Candidates: real_rate, dxy, vix, yield_spread, dgs10, dgs2, inflation_expectation. Should rates be converted to changes rather than levels?",
    "Q4: Should the Sharpe formula use cost on every day or only on position changes? The CLAUDE.md evaluator spec uses position-change cost, but src/evaluation.py uses daily cost. Which should the training notebook match?",
    "Q5: What data imputation strategy should be used for early-period rows where some submodel outputs are NaN? Options: (a) forward-fill, (b) fill with unconditional mean, (c) fill with 0.5 for regime_prob and 0 for z-scores, (d) drop rows. Current approach (d) lost 45% of data."
  ],

  "constraints": [
    "Data split frozen: 70/15/15 (time-series order, no shuffle)",
    "No future information leakage",
    "5-day data delay maximum",
    "Self-contained Kaggle Notebook (all code in single notebook)",
    "Optuna HP optimization with minimum 50 trials",
    "Meta-model does NOT predict gold prices (it predicts gold returns)",
    "NO raw price-level features (gld_open/high/low/close, silver_close, copper_close, sp500_close, volumes, volume_ma20)",
    "NO CNY demand features (cny_regime_prob, cny_momentum_z, cny_vol_regime_z, cny_demand_cny_usd)",
    "NO custom directional-weighted MAE loss -- use standard reg:squarederror",
    "Train-test DA gap MUST be < 10pp (Attempt 1 had 40pp gap)",
    "Sharpe formula must use cost on position changes only (matching CLAUDE.md evaluator spec)"
  ],

  "known_issues": {
    "attempt1_overfitting": "Train DA 94.3% vs Val DA 46.9% (47pp gap). Caused by directional-weighted MAE with penalty=4.52 and non-stationary price-level features.",
    "attempt1_data_loss": "Notebook inner join + dropna reduced 2523 rows to 1378 (45.4% loss). Must fix timezone handling and NaN imputation.",
    "attempt1_magnitude_suppression": "Predictions std = 0.062% vs actual std = 1.307% (4.7% ratio). Custom loss caused model to make tiny conservative predictions.",
    "attempt1_worse_than_naive": "Model DA 54.1% < naive always-up DA 59.9% on test set.",
    "sharpe_formula_discrepancy": "Training notebook deducts 5bps daily (Sharpe=0.428). CLAUDE.md formula deducts on trades only (Sharpe=1.027). Must align to CLAUDE.md."
  },

  "previous_feedback": {
    "attempt": 1,
    "result": "FAIL - all 4 targets missed",
    "root_causes": [
      "Directional-weighted MAE with penalty=4.52 caused catastrophic overfitting (train DA 94.3%, val DA 46.9%)",
      "Non-stationary price-level features dominated importance (top 5) causing regime-dependent overfitting",
      "Data pipeline lost 45.4% of rows (964 train instead of ~1700+)",
      "CNY features added directional noise (DA -2.06%, Sharpe -0.593 in Phase 2 ablation)",
      "Sharpe formula inconsistency between training and evaluation"
    ],
    "improvement_actions": [
      "MANDATORY: Drop directional-weighted MAE, use reg:squarederror",
      "MANDATORY: Drop all 11 non-stationary price-level base features",
      "MANDATORY: Drop all 4 CNY features",
      "MANDATORY: Fix data pipeline to retain ~2000+ training samples",
      "MANDATORY: Align Sharpe to CLAUDE.md (cost on trades only)",
      "MANDATORY: Strengthen regularization (lambda [3,20], alpha [1,10], max_depth [2,4], min_child_weight [10,30])"
    ],
    "metrics": {
      "test_da": 0.541,
      "test_hcda": 0.543,
      "test_mae": 0.978,
      "test_sharpe": 0.428,
      "train_test_da_gap": 40.15,
      "naive_always_up_da": 0.599
    }
  },

  "success_criteria": "Test set must achieve ALL of: DA > 56%, HC-DA > 60%, MAE < 0.75%, Sharpe > 0.8 (after 5bps costs on position changes). Train-test DA gap < 10pp.",

  "expected_artifacts": [
    "docs/research/meta_model_attempt_2.md",
    "docs/design/meta_model_attempt_2.md",
    "notebooks/meta_model_2/train.ipynb",
    "logs/evaluation/meta_model_attempt_2_summary.md"
  ],

  "created_at": "2026-02-15T22:00:00",
  "created_by": "evaluator"
}
